name: Kube

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  k3d-test:
    name: Test Deployment in K3d
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache: true
        cache-dependency-path: go.sum

    - name: Install Task
      run: sudo snap install task --classic

    - name: Install k3d
      run: |
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

    - name: Setup k3d cluster
      run: |
        task k3d:setup

    - name: Run integration tests
      run: |
        go test -v -tags=integration ./pkg/kubernetes -timeout 5m

    - name: Verify VLLMModels
      run: |
        kubectl get models
        kubectl get model qwen3-coder-30b-fp8 -o yaml

    - name: Deploy RBAC
      run: kubectl apply -f manifests/ci/rbac.yaml

    - name: Verify RBAC permissions
      run: |
        echo "Testing cluster-scoped permissions (VLLMModels)..."
        kubectl auth can-i get models --as=system:serviceaccount:vllm:vllm-chill
        kubectl auth can-i list models --as=system:serviceaccount:vllm:vllm-chill
        
        echo "Testing namespace-scoped permissions..."
        kubectl auth can-i get deployments --namespace=vllm --as=system:serviceaccount:vllm:vllm-chill
        kubectl auth can-i create deployments --namespace=vllm --as=system:serviceaccount:vllm:vllm-chill
        kubectl auth can-i patch configmaps --namespace=vllm --as=system:serviceaccount:vllm:vllm-chill

    - name: Validate VLLMModel specs
      run: |
        echo "Validating qwen3-coder model..."
        kubectl get model qwen3-coder-30b-fp8 -o jsonpath='{.spec.servedModelName}'
        echo ""
        
        echo "Validating deepseek-r1 model..."
        kubectl get model deepseek-r1-fp8 -o jsonpath='{.spec.servedModelName}'
        echo ""

    - name: Test model listing
      run: |
        echo "All models:"
        kubectl get models -o wide
        
        echo ""
        echo "Model details (JSON):"
        kubectl get models -o json | jq '.items[] | {name: .metadata.name, servedModelName: .spec.servedModelName, modelName: .spec.modelName}'

    - name: Verify CRD schema validation
      run: |
        echo "Testing invalid model (should fail)..."
        cat > invalid-model.yaml << 'EOF'
        apiVersion: vllm.sir-alfred.io/v1alpha1
        kind: VLLMModel
        metadata:
          name: invalid-model
        spec:
          modelName: "test/model"
          servedModelName: "invalid"
          dtype: "invalid-dtype"  # Should fail validation (not in enum)
          gpuMemoryUtilization: 1.5  # Should fail (maximum 1.0)
        EOF

        if kubectl apply -f invalid-model.yaml 2>&1 | grep -qE "(Invalid value|not valid)"; then
          echo "✅ CRD validation working correctly"
        else
          echo "❌ CRD validation not working"
          exit 1
        fi

    - name: Summary
      if: always()
      run: |
        echo "=== Cluster Resources ==="
        kubectl get models
        echo ""
        echo "=== Namespace Resources ==="
        kubectl get all -n vllm
        echo ""
        echo "=== RBAC ==="
        kubectl get sa,role,rolebinding -n vllm
        kubectl get clusterrole,clusterrolebinding | grep vllm-chill

    - name: Cleanup
      if: always()
      run: |
        k3d cluster delete vllm-test
